<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.120.3">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Short anatomy of node-redis client &middot; Ramana Venkata</title>

  
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://blog.vramana.com/"><h1>Ramana Venkata</h1></a>
      <p class="lead">
       Senior Software Engineer with an interest in Javascript, TypeScript and Rust 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://blog.vramana.com/">Home</a> </li>
        <li><a rel="me" href="/about/"> About </a></li><li><a rel="me" href="https://github.com/vramana"> Github </a></li><li><a rel="me" href="https://www.linkedin.com/in/vramanamath/"> LinkedIn </a></li><li><a rel="me" href="https://mastodon.social/@vramana"> Mastodon </a></li>
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Short anatomy of node-redis client</h1>
  <time datetime=2022-06-25T00:00:00Z class="post-date">Sat, Jun 25, 2022</time>
  <p>I am trying to write simple redis-client in rust. As part of that exercise, I have read the source code of
Node.js Redis Client. I want to jot down some notes on how it works.</p>
<p>A Redis Client opens a TCP connection and it writes and reads over that connection.
We will to examine these 3 things in detail. Opening a connection, writing a command and reading a reponse.</p>
<h3 id="opening-a-connection">Opening a connection</h3>
<p><code>RedisClient</code> definition in <a href="https://github.dev/redis/node-redis/blob/bf80c163b1305a859baa3dbc0bd6488c300e7a4f/packages/client/lib/client/index.ts#L74">this file</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> RedisClient {
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>  <span style="color:#ff7b72">constructor</span>(options?: <span style="color:#ff7b72">RedisClientOptions</span>&lt;<span style="color:#7ee787">M</span><span style="color:#f85149">,</span> F<span style="color:#f85149">,</span> S&gt;) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">super</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>initiateOptions(options);
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>initiateQueue();
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>initiateSocket();
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>}
</span></span></code></pre></div><p>In the constructor, we see that <code>RedisClient</code> object has two private variables <code>this.#queue</code> &amp; <code>this.#socket</code> that are relevant to us.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> RedisClient {
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>    <span style="color:#f85149">#</span>initiateSocket()<span style="color:#ff7b72;font-weight:bold">:</span> RedisSocket {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">const</span> socketInitiator <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">async</span> ()<span style="color:#ff7b72;font-weight:bold">:</span> Promise&lt;<span style="color:#7ee787">void</span>&gt; <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> promises <span style="color:#ff7b72;font-weight:bold">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>selectedDB <span style="color:#ff7b72;font-weight:bold">!==</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>                promises.push(
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.addCommand(
</span></span><span style="display:flex;"><span>                        [<span style="color:#a5d6ff">&#39;SELECT&#39;</span>, <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>selectedDB.toString()],
</span></span><span style="display:flex;"><span>                        { asap: <span style="color:#ff7b72">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.<span style="color:#ff7b72">readonly</span>) {
</span></span><span style="display:flex;"><span>                promises.push(
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.addCommand(
</span></span><span style="display:flex;"><span>                        COMMANDS.READONLY.transformArguments(),
</span></span><span style="display:flex;"><span>                        { asap: <span style="color:#ff7b72">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.name) {
</span></span><span style="display:flex;"><span>                promises.push(
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.addCommand(
</span></span><span style="display:flex;"><span>                        COMMANDS.CLIENT_SETNAME.transformArguments(<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options.name),
</span></span><span style="display:flex;"><span>                        { asap: <span style="color:#ff7b72">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.username <span style="color:#ff7b72;font-weight:bold">||</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.password) {
</span></span><span style="display:flex;"><span>                promises.push(
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.addCommand(
</span></span><span style="display:flex;"><span>                        COMMANDS.AUTH.transformArguments({
</span></span><span style="display:flex;"><span>                            username: <span style="color:#ff7b72">this.</span><span style="color:#f85149">#</span>options.username,
</span></span><span style="display:flex;"><span>                            password: <span style="color:#ff7b72">this.</span><span style="color:#f85149">#</span>options.password <span style="color:#ff7b72;font-weight:bold">??</span> <span style="color:#a5d6ff">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                        }),
</span></span><span style="display:flex;"><span>                        { asap: <span style="color:#ff7b72">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> resubscribePromise <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.resubscribe();
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (resubscribePromise) {
</span></span><span style="display:flex;"><span>                promises.push(resubscribePromise);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (promises.length) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>tick(<span style="color:#79c0ff">true</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">await</span> Promise.all(promises);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">new</span> RedisSocket(socketInitiator, <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.socket)
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;data&#39;</span>, chunk <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.onReplyChunk(chunk))
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;error&#39;</span>, err <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;error&#39;</span>, err);
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.isOpen <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.disableOfflineQueue) {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.flushWaitingForReply(err);
</span></span><span style="display:flex;"><span>                } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.flushAll(err);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;connect&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;connect&#39;</span>))
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;ready&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;ready&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>tick();
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;reconnecting&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;reconnecting&#39;</span>))
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;drain&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>tick())
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;end&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;end&#39;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>}
</span></span></code></pre></div><p><code>initiateSocket</code> method returns a <code>RedisSocket</code> object which is turn an <code>EventEmitter</code>.
The method also pushes some commands onto <code>this.#queue</code>.
<code>RedisSocket</code> definition is in <a href="https://github.dev/redis/node-redis/blob/23b65133c9610c44f336199a1ea73e77a9b73bc7/packages/client/lib/client/socket.ts#L32">this file</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#ff7b72">class</span> RedisSocket {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b949e;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>    <span style="color:#ff7b72">async</span> <span style="color:#f85149">#</span>connect(retries: <span style="color:#ff7b72">number</span>, hadError?: <span style="color:#ff7b72">boolean</span>)<span style="color:#ff7b72;font-weight:bold">:</span> Promise&lt;<span style="color:#7ee787">void</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> (retries <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span> <span style="color:#ff7b72;font-weight:bold">||</span> hadError) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;reconnecting&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>isOpen <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">await</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>createSocket();
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>writableNeedDrain <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;connect&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">await</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>initiator();
</span></span><span style="display:flex;"><span>            } <span style="color:#ff7b72">catch</span> (err) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.destroy();
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">undefined</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">throw</span> err;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>isReady <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;ready&#39;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff7b72">catch</span> (err) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;error&#39;</span>, err);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> retryIn <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.reconnectStrategy <span style="color:#ff7b72;font-weight:bold">??</span> RedisSocket.<span style="color:#f85149">#</span>defaultReconnectStrategy)(retries);
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (retryIn <span style="color:#ff7b72">instanceof</span> Error) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>isOpen <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">false</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> ReconnectStrategyError(retryIn, err);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">await</span> promiseTimeout(retryIn);
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>connect(retries <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f85149">#</span>createSocket()<span style="color:#ff7b72;font-weight:bold">:</span> Promise&lt;<span style="color:#7ee787">net.Socket</span> <span style="color:#f85149">|</span> tls.TLSSocket&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">new</span> Promise((resolve, reject) <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> {connectEvent, socket} <span style="color:#ff7b72;font-weight:bold">=</span> RedisSocket.<span style="color:#f85149">#</span>isTlsSocket(<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options) <span style="color:#ff7b72;font-weight:bold">?</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>createTlsSocket() <span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>createNetSocket();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options.connectTimeout) {
</span></span><span style="display:flex;"><span>                socket.setTimeout(<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options.connectTimeout, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> socket.destroy(<span style="color:#ff7b72">new</span> ConnectionTimeoutError()));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            socket
</span></span><span style="display:flex;"><span>                .setNoDelay(<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options.noDelay)
</span></span><span style="display:flex;"><span>                .once(<span style="color:#a5d6ff">&#39;error&#39;</span>, reject)
</span></span><span style="display:flex;"><span>                .once(connectEvent, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    socket
</span></span><span style="display:flex;"><span>                        .setTimeout(<span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#8b949e;font-style:italic">// https://github.com/nodejs/node/issues/31663
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>                        .setKeepAlive(<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options.keepAlive <span style="color:#ff7b72;font-weight:bold">!==</span> <span style="color:#79c0ff">false</span>, <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options.keepAlive <span style="color:#ff7b72;font-weight:bold">||</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>                        .off(<span style="color:#a5d6ff">&#39;error&#39;</span>, reject)
</span></span><span style="display:flex;"><span>                        .once(<span style="color:#a5d6ff">&#39;error&#39;</span>, (err: <span style="color:#ff7b72">Error</span>) <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>onSocketError(err))
</span></span><span style="display:flex;"><span>                        .once(<span style="color:#a5d6ff">&#39;close&#39;</span>, hadError <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>hadError <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>isOpen <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket <span style="color:#ff7b72;font-weight:bold">===</span> socket) {
</span></span><span style="display:flex;"><span>                                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>onSocketError(<span style="color:#ff7b72">new</span> SocketClosedUnexpectedlyError());
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                        .on(<span style="color:#a5d6ff">&#39;drain&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>writableNeedDrain <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">false</span>;
</span></span><span style="display:flex;"><span>                            <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;drain&#39;</span>);
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                        .on(<span style="color:#a5d6ff">&#39;data&#39;</span>, data <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;data&#39;</span>, data));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    resolve(socket);
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f85149">#</span>createNetSocket()<span style="color:#ff7b72;font-weight:bold">:</span> CreateSocketReturn&lt;<span style="color:#7ee787">net.Socket</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> {
</span></span><span style="display:flex;"><span>            connectEvent<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#39;connect&#39;</span>,
</span></span><span style="display:flex;"><span>            socket: <span style="color:#ff7b72">net.connect</span>(<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options <span style="color:#ff7b72">as</span> net.NetConnectOpts) <span style="color:#8b949e;font-style:italic">// TODO
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b949e;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>}
</span></span></code></pre></div><p>The <code>#createSocket</code> &amp; <code>#createNetSocket</code> method finally lead us to TCP connection logic we are looking for.</p>
<p>From Node.js documentation, <code>net</code> module</p>
<blockquote>
<p>The net module provides an asynchronous network API for creating stream-based TCP or IPC servers (net.createServer()) and clients (net.createConnection()).</p>
</blockquote>
<h3 id="writing-commands">Writing commands</h3>
<p>Once the connection is established, we trigger several callbacks that we have setup so far.
The <code>socket</code> connected is stored in <code>this.#socket</code> and the <code>this.#initiator</code> callback is called (<a href="https://github.dev/redis/node-redis/blob/23b65133c9610c44f336199a1ea73e77a9b73bc7/packages/client/lib/client/socket.ts#L108">socket.ts L108</a>) which is passed
as the argument to be <code>RedisSocket</code> constructor.</p>
<p>There are several commands queued from the initiator callback ([socket.ts L224-261]).
Let&rsquo;s look at <code>this.#queue</code> from <code>RedisClient</code>. <code>this.#queue</code> is an instance of <code>RedisCommandQueue</code>.
<code>RedisCommandQueue</code> definition is in <a href="https://github.dev/redis/node-redis/blob/0752f143a6dbc83df0a5db987907e8794aabe9db/packages/client/lib/client/commands-queue.ts#L53">this file</a>.</p>
<p><code>RedisCommandQueue</code> is backed by two doubly-linked lists (<a href="https://www.npmjs.com/package/yallist">yallist</a>) <code>#waitingToBeSent</code> and <code>#waitingForReply</code>.
The names are self explanatory, one queue for keep commands yet to sent and the other for response yet to be recieved.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    addCommand&lt;<span style="color:#7ee787">T</span> <span style="color:#f85149">=</span> RedisCommandRawReply&gt;(args: <span style="color:#ff7b72">RedisCommandArguments</span>, options?: <span style="color:#ff7b72">QueueCommandOptions</span>)<span style="color:#ff7b72;font-weight:bold">:</span> Promise&lt;<span style="color:#7ee787">T</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>pubSubState.isActive <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.ignorePubSubMode) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> Promise.reject(<span style="color:#ff7b72">new</span> Error(<span style="color:#a5d6ff">&#39;Cannot send commands in PubSub mode&#39;</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>maxLength <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingToBeSent.length <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingForReply.length <span style="color:#ff7b72;font-weight:bold">&gt;=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>maxLength) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> Promise.reject(<span style="color:#ff7b72">new</span> Error(<span style="color:#a5d6ff">&#39;The queue is full&#39;</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (options<span style="color:#ff7b72;font-weight:bold">?</span>.signal<span style="color:#ff7b72;font-weight:bold">?</span>.aborted) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> Promise.reject(<span style="color:#ff7b72">new</span> AbortError());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">new</span> Promise((resolve, reject) <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> node <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">new</span> LinkedList.Node&lt;<span style="color:#7ee787">CommandWaitingToBeSent</span>&gt;({
</span></span><span style="display:flex;"><span>                args,
</span></span><span style="display:flex;"><span>                chainId: <span style="color:#ff7b72">options?.chainId</span>,
</span></span><span style="display:flex;"><span>                returnBuffers: <span style="color:#ff7b72">options?.returnBuffers</span>,
</span></span><span style="display:flex;"><span>                resolve,
</span></span><span style="display:flex;"><span>                reject
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (options<span style="color:#ff7b72;font-weight:bold">?</span>.signal) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">const</span> listener <span style="color:#ff7b72;font-weight:bold">=</span> () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingToBeSent.removeNode(node);
</span></span><span style="display:flex;"><span>                    node.value.reject(<span style="color:#ff7b72">new</span> AbortError());
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                node.value.abort <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>                    signal: <span style="color:#ff7b72">options.signal</span>,
</span></span><span style="display:flex;"><span>                    listener
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#8b949e;font-style:italic">// AbortSignal type is incorrent
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>                (options.signal <span style="color:#ff7b72">as</span> <span style="color:#ff7b72">any</span>).addEventListener(<span style="color:#a5d6ff">&#39;abort&#39;</span>, listener, {
</span></span><span style="display:flex;"><span>                    once: <span style="color:#ff7b72">true</span>
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (options<span style="color:#ff7b72;font-weight:bold">?</span>.asap) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingToBeSent.unshiftNode(node);
</span></span><span style="display:flex;"><span>            } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingToBeSent.pushNode(node);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Every command enqueued returns a Promise so it&rsquo;s caller can recieve the response asynchronously.
The command is stored as an object along with the promise&rsquo;s resolve and reject functions.</p>
<p>One thing to note the queues are using doubly-linked lists so commands if need be can be added to the front of the queue.
All the commands in the socket initiator pass an additional argument <code>{ asap: true }</code>.
The authentication command is the last command enqueued from socket initiator with <code>{ asap: true }</code> so it will be exectued first.</p>
<p>So far we queued commands, Let&rsquo;s examine how they are sent.</p>
<p><code>RedisSocket.#socket</code> will emit a <code>ready</code> event and <code>RedisSocket</code> will in turn emit <code>ready</code> event too.
In <code>RedisClient.#initiateSocket</code>, <code>RedisSocket</code> has a callback for <code>ready</code> event.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">new</span> RedisSocket(socketInitiator, <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.socket)
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;data&#39;</span>, chunk <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.onReplyChunk(chunk))
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;error&#39;</span>, err <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;error&#39;</span>, err);
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.isOpen <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.disableOfflineQueue) {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.flushWaitingForReply(err);
</span></span><span style="display:flex;"><span>                } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.flushAll(err);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;connect&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;connect&#39;</span>))
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;ready&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;ready&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>tick();
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;reconnecting&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;reconnecting&#39;</span>))
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;drain&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>tick())
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;end&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.emit(<span style="color:#a5d6ff">&#39;end&#39;</span>));
</span></span></code></pre></div><p>Let&rsquo;s examine <code>RedisClient.#tick</code> method and related methods</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#f85149">#</span>tick(force <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">false</span>)<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#ff7b72">void</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.writableNeedDrain <span style="color:#ff7b72;font-weight:bold">||</span> (<span style="color:#ff7b72;font-weight:bold">!</span>force <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.isReady)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.cork();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">while</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.writableNeedDrain) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> args <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.getCommandToSend();
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (args <span style="color:#ff7b72;font-weight:bold">===</span> <span style="color:#79c0ff">undefined</span>) <span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.writeCommand(args);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    getCommandToSend()<span style="color:#ff7b72;font-weight:bold">:</span> RedisCommandArguments <span style="color:#ff7b72;font-weight:bold">|</span> <span style="color:#79c0ff">undefined</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">const</span> toSend <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingToBeSent.shift();
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>toSend) <span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">let</span> encoded: <span style="color:#ff7b72">RedisCommandArguments</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span> {
</span></span><span style="display:flex;"><span>            encoded <span style="color:#ff7b72;font-weight:bold">=</span> encodeCommand(toSend.args);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff7b72">catch</span> (err) {
</span></span><span style="display:flex;"><span>            toSend.reject(err);
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingForReply.push({
</span></span><span style="display:flex;"><span>            resolve: <span style="color:#ff7b72">toSend.resolve</span>,
</span></span><span style="display:flex;"><span>            reject: <span style="color:#ff7b72">toSend.reject</span>,
</span></span><span style="display:flex;"><span>            channelsCounter: <span style="color:#ff7b72">toSend.channelsCounter</span>,
</span></span><span style="display:flex;"><span>            returnBuffers: <span style="color:#ff7b72">toSend.returnBuffers</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>chainInExecution <span style="color:#ff7b72;font-weight:bold">=</span> toSend.chainId;
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> encoded;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    writeCommand(args: <span style="color:#ff7b72">RedisCommandArguments</span>)<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#ff7b72">void</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> ClientClosedError();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">for</span> (<span style="color:#ff7b72">const</span> toWrite <span style="color:#ff7b72">of</span> args) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>writableNeedDrain <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>socket.write(toWrite);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><code>this.#socket.cork()</code> is a rabbit hole on it&rsquo;s own. This <a href="https://baus.net/on-tcp_cork/">blog post</a> explains it in a good detail.</p>
<p><code>RedisCommandQueue.getCommandToSend</code> method will pop the first command off the the queue and encode the command in RESP2 protocol.
<code>RedisCommandQueue.#waitingForReply</code> queue is enqueued with node containing <code>RedisCommandQueue.addCommand</code> return value promise&rsquo;s
<code>resolve</code> and <code>reject</code> so they can be called once a response is recieved.</p>
<p>The encoded command is written to the socket in <code>RedisSocket.writeCommand</code> with <code>this.#socket.write</code>.
<code>RedisSocket.#writableNeedDrain</code> tracks if the TCP socket&rsquo;s buffer is full and stops <code>RedisClient.#tick</code> from enqueueing more commands.</p>
<blockquote>
<p>Returns true if the entire data was flushed successfully to the kernel buffer. Returns false if all or part of the data was queued in user memory. &lsquo;drain&rsquo; will be emitted when the buffer is again free.</p>
</blockquote>
<p><a href="https://nodejs.org/api/net.html#socketwritedata-encoding-callback">socket.write documentation</a></p>
<p>Is this handling backpressure? Yep. It seems so. Read this great <a href="https://ey3ball.github.io/posts/2014/07/17/node-streams-back-pressure/">blog post</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;drain&#39;</span>, () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>tick())
</span></span></code></pre></div><p><code>RedisClient.#tick</code> will enqueue command until <code>RedisSocket.#writableNeedDrain</code> is true.
<code>RedisClient.#tick</code> will be called again when <code>RedisSocket</code> will emit <code>drain</code>.</p>
<h3 id="reading-a-response">Reading a response</h3>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">new</span> RedisSocket(socketInitiator, <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>options<span style="color:#ff7b72;font-weight:bold">?</span>.socket)
</span></span><span style="display:flex;"><span>            .on(<span style="color:#a5d6ff">&#39;data&#39;</span>, chunk <span style="color:#ff7b72;font-weight:bold">=&gt;</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>queue.onReplyChunk(chunk))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    onReplyChunk(chunk: <span style="color:#ff7b72">Buffer</span>)<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#ff7b72">void</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>decoder.write(chunk);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><code>RedisSocket</code> will queue data coming from the TCP socket to <code>RedisCommandQueue.onReplyChunk</code> method.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#f85149">#</span>decoder <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">new</span> RESP2Decoder({
</span></span><span style="display:flex;"><span>        returnStringsAsBuffers<span style="color:#ff7b72;font-weight:bold">:</span> () <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">!!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingForReply.head<span style="color:#ff7b72;font-weight:bold">?</span>.value.returnBuffers <span style="color:#ff7b72;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>pubSubState.isActive;
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        onReply: <span style="color:#ff7b72">reply</span> <span style="color:#ff7b72;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>handlePubSubReply(reply)) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingForReply.length) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff7b72">throw</span> <span style="color:#ff7b72">new</span> Error(<span style="color:#a5d6ff">&#39;Got an unexpected reply from Redis&#39;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">const</span> { resolve, reject } <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">this</span>.<span style="color:#f85149">#</span>waitingForReply.shift()<span style="color:#ff7b72;font-weight:bold">!</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">if</span> (reply <span style="color:#ff7b72">instanceof</span> ErrorReply) {
</span></span><span style="display:flex;"><span>                reject(reply);
</span></span><span style="display:flex;"><span>            } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>                resolve(reply);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><p><code>RESP2Decoder</code> will decode the response and call <code>onReply</code>.
<code>RedisCommandQueue.#waitingForReply</code> will pop a node so that it can finally settle to the Promise that was created in <code>RedisCommandQueue.addCommand</code>.</p>
<p>What a journey! I feel great understanding how all this works.</p>
</div>


    </main>
    <script defer data-domain="blog.vramana.com" src="https://plausible.vramana.com/js/script.js"></script>
  </body>
</html>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.117.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Short anatomy of node-redis client &middot; Ramana Venkata</title>

  
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://blog.vramana.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://blog.vramana.com/"><h1>Ramana Venkata</h1></a>
      <p class="lead">
       Senior Software Engineer with an interest in Javascript, TypeScript and Rust 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://blog.vramana.com/">Home</a> </li>
        <li><a rel="me" href="/about/"> About </a></li><li><a rel="me" href="https://github.com/vramana"> Github </a></li><li><a rel="me" href="https://www.linkedin.com/in/vramanamath/"> LinkedIn </a></li><li><a rel="me" href="https://mastodon.social/@vramana"> Mastodon </a></li>
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Short anatomy of node-redis client</h1>
  <time datetime=2022-06-25T00:00:00Z class="post-date">Sat, Jun 25, 2022</time>
  <p>I am trying to write simple redis-client in rust. As part of that exercise, I have read the source code of
Node.js Redis Client. I want to jot down some notes on how it works.</p>
<p>A Redis Client opens a TCP connection and it writes and reads over that connection.
We will to examine these 3 things in detail. Opening a connection, writing a command and reading a reponse.</p>
<h3 id="opening-a-connection">Opening a connection</h3>
<p><code>RedisClient</code> definition in <a href="https://github.dev/redis/node-redis/blob/bf80c163b1305a859baa3dbc0bd6488c300e7a4f/packages/client/lib/client/index.ts#L74">this file</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisClient</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">constructor</span>(<span style="color:#a6e22e">options?</span>: <span style="color:#66d9ef">RedisClientOptions</span>&lt;<span style="color:#f92672">M</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">F</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">S</span>&gt;) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">initiateOptions</span>(<span style="color:#a6e22e">options</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">initiateQueue</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">initiateSocket</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>In the constructor, we see that <code>RedisClient</code> object has two private variables <code>this.#queue</code> &amp; <code>this.#socket</code> that are relevant to us.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisClient</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">initiateSocket</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">RedisSocket</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">socketInitiator</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> ()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">promises</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">selectedDB</span> <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">push</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">addCommand</span>(
</span></span><span style="display:flex;"><span>                        [<span style="color:#e6db74">&#39;SELECT&#39;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">selectedDB</span>.<span style="color:#a6e22e">toString</span>()],
</span></span><span style="display:flex;"><span>                        { <span style="color:#a6e22e">asap</span>: <span style="color:#66d9ef">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#66d9ef">readonly</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">push</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">addCommand</span>(
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">COMMANDS</span>.<span style="color:#a6e22e">READONLY</span>.<span style="color:#a6e22e">transformArguments</span>(),
</span></span><span style="display:flex;"><span>                        { <span style="color:#a6e22e">asap</span>: <span style="color:#66d9ef">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">name</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">push</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">addCommand</span>(
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">COMMANDS</span>.<span style="color:#a6e22e">CLIENT_SETNAME</span>.<span style="color:#a6e22e">transformArguments</span>(<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">name</span>),
</span></span><span style="display:flex;"><span>                        { <span style="color:#a6e22e">asap</span>: <span style="color:#66d9ef">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">password</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">push</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">addCommand</span>(
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">COMMANDS</span>.<span style="color:#a6e22e">AUTH</span>.<span style="color:#a6e22e">transformArguments</span>({
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">username</span>: <span style="color:#66d9ef">this.</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">username</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">password</span>: <span style="color:#66d9ef">this.</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">password</span> <span style="color:#f92672">??</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                        }),
</span></span><span style="display:flex;"><span>                        { <span style="color:#a6e22e">asap</span>: <span style="color:#66d9ef">true</span> }
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resubscribePromise</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">resubscribe</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resubscribePromise</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">resubscribePromise</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">promises</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">all</span>(<span style="color:#a6e22e">promises</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RedisSocket</span>(<span style="color:#a6e22e">socketInitiator</span>, <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">socket</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">onReplyChunk</span>(<span style="color:#a6e22e">chunk</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">isOpen</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">disableOfflineQueue</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">flushWaitingForReply</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">flushAll</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;connect&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;connect&#39;</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;ready&#39;</span>, () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;ready&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>();
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;reconnecting&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;reconnecting&#39;</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;drain&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>())
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;end&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><code>initiateSocket</code> method returns a <code>RedisSocket</code> object which is turn an <code>EventEmitter</code>.
The method also pushes some commands onto <code>this.#queue</code>.
<code>RedisSocket</code> definition is in <a href="https://github.dev/redis/node-redis/blob/23b65133c9610c44f336199a1ea73e77a9b73bc7/packages/client/lib/client/socket.ts#L32">this file</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisSocket</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">async</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">retries</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">hadError?</span>: <span style="color:#66d9ef">boolean</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">void</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">retries</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">hadError</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;reconnecting&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">isOpen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">createSocket</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">writableNeedDrain</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;connect&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">initiator</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">destroy</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">err</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">isReady</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;ready&#39;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">retryIn</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">reconnectStrategy</span> <span style="color:#f92672">??</span> <span style="color:#a6e22e">RedisSocket</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">defaultReconnectStrategy</span>)(<span style="color:#a6e22e">retries</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">retryIn</span> <span style="color:#66d9ef">instanceof</span> Error) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">isOpen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ReconnectStrategyError</span>(<span style="color:#a6e22e">retryIn</span>, <span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">promiseTimeout</span>(<span style="color:#a6e22e">retryIn</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">connect</span>(<span style="color:#a6e22e">retries</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">createSocket</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">net.Socket</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">tls.TLSSocket</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Promise</span>((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> {<span style="color:#a6e22e">connectEvent</span>, <span style="color:#a6e22e">socket</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">RedisSocket</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">isTlsSocket</span>(<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>) <span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">createTlsSocket</span>() <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">createNetSocket</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">connectTimeout</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">connectTimeout</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">destroy</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ConnectionTimeoutError</span>()));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">socket</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setNoDelay</span>(<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">noDelay</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">once</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">reject</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">once</span>(<span style="color:#a6e22e">connectEvent</span>, () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">socket</span>
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">setTimeout</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// https://github.com/nodejs/node/issues/31663
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        .<span style="color:#a6e22e">setKeepAlive</span>(<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">keepAlive</span> <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">keepAlive</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">off</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">reject</span>)
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">once</span>(<span style="color:#e6db74">&#39;error&#39;</span>, (<span style="color:#a6e22e">err</span>: <span style="color:#66d9ef">Error</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">onSocketError</span>(<span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">once</span>(<span style="color:#e6db74">&#39;close&#39;</span>, <span style="color:#a6e22e">hadError</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">hadError</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">isOpen</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">socket</span>) {
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">onSocketError</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SocketClosedUnexpectedlyError</span>());
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;drain&#39;</span>, () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">writableNeedDrain</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;drain&#39;</span>);
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#a6e22e">data</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#a6e22e">data</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">socket</span>);
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">createNetSocket</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">CreateSocketReturn</span>&lt;<span style="color:#f92672">net.Socket</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">connectEvent</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;connect&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">socket</span>: <span style="color:#66d9ef">net.connect</span>(<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">NetConnectOpts</span>) <span style="color:#75715e">// TODO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>The <code>#createSocket</code> &amp; <code>#createNetSocket</code> method finally lead us to TCP connection logic we are looking for.</p>
<p>From Node.js documentation, <code>net</code> module</p>
<blockquote>
<p>The net module provides an asynchronous network API for creating stream-based TCP or IPC servers (net.createServer()) and clients (net.createConnection()).</p>
</blockquote>
<h3 id="writing-commands">Writing commands</h3>
<p>Once the connection is established, we trigger several callbacks that we have setup so far.
The <code>socket</code> connected is stored in <code>this.#socket</code> and the <code>this.#initiator</code> callback is called (<a href="https://github.dev/redis/node-redis/blob/23b65133c9610c44f336199a1ea73e77a9b73bc7/packages/client/lib/client/socket.ts#L108">socket.ts L108</a>) which is passed
as the argument to be <code>RedisSocket</code> constructor.</p>
<p>There are several commands queued from the initiator callback ([socket.ts L224-261]).
Let&rsquo;s look at <code>this.#queue</code> from <code>RedisClient</code>. <code>this.#queue</code> is an instance of <code>RedisCommandQueue</code>.
<code>RedisCommandQueue</code> definition is in <a href="https://github.dev/redis/node-redis/blob/0752f143a6dbc83df0a5db987907e8794aabe9db/packages/client/lib/client/commands-queue.ts#L53">this file</a>.</p>
<p><code>RedisCommandQueue</code> is backed by two doubly-linked lists (<a href="https://www.npmjs.com/package/yallist">yallist</a>) <code>#waitingToBeSent</code> and <code>#waitingForReply</code>.
The names are self explanatory, one queue for keep commands yet to sent and the other for response yet to be recieved.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#a6e22e">addCommand</span>&lt;<span style="color:#f92672">T</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#a6e22e">RedisCommandRawReply</span>&gt;(<span style="color:#a6e22e">args</span>: <span style="color:#66d9ef">RedisCommandArguments</span>, <span style="color:#a6e22e">options?</span>: <span style="color:#66d9ef">QueueCommandOptions</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">T</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">pubSubState</span>.<span style="color:#a6e22e">isActive</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">ignorePubSubMode</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Cannot send commands in PubSub mode&#39;</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">maxLength</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingToBeSent</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingForReply</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">maxLength</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;The queue is full&#39;</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">signal</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">aborted</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AbortError</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Promise</span>((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">node</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LinkedList</span>.<span style="color:#a6e22e">Node</span>&lt;<span style="color:#f92672">CommandWaitingToBeSent</span>&gt;({
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">args</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">chainId</span>: <span style="color:#66d9ef">options?.chainId</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">returnBuffers</span>: <span style="color:#66d9ef">options?.returnBuffers</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">resolve</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reject</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">signal</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">listener</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingToBeSent</span>.<span style="color:#a6e22e">removeNode</span>(<span style="color:#a6e22e">node</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AbortError</span>());
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">abort</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">signal</span>: <span style="color:#66d9ef">options.signal</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">listener</span>
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// AbortSignal type is incorrent
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                (<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">signal</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>).<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;abort&#39;</span>, <span style="color:#a6e22e">listener</span>, {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">once</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">asap</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingToBeSent</span>.<span style="color:#a6e22e">unshiftNode</span>(<span style="color:#a6e22e">node</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingToBeSent</span>.<span style="color:#a6e22e">pushNode</span>(<span style="color:#a6e22e">node</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Every command enqueued returns a Promise so it&rsquo;s caller can recieve the response asynchronously.
The command is stored as an object along with the promise&rsquo;s resolve and reject functions.</p>
<p>One thing to note the queues are using doubly-linked lists so commands if need be can be added to the front of the queue.
All the commands in the socket initiator pass an additional argument <code>{ asap: true }</code>.
The authentication command is the last command enqueued from socket initiator with <code>{ asap: true }</code> so it will be exectued first.</p>
<p>So far we queued commands, Let&rsquo;s examine how they are sent.</p>
<p><code>RedisSocket.#socket</code> will emit a <code>ready</code> event and <code>RedisSocket</code> will in turn emit <code>ready</code> event too.
In <code>RedisClient.#initiateSocket</code>, <code>RedisSocket</code> has a callback for <code>ready</code> event.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RedisSocket</span>(<span style="color:#a6e22e">socketInitiator</span>, <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">socket</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">onReplyChunk</span>(<span style="color:#a6e22e">chunk</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">isOpen</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">disableOfflineQueue</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">flushWaitingForReply</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">flushAll</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;connect&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;connect&#39;</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;ready&#39;</span>, () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;ready&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>();
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;reconnecting&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;reconnecting&#39;</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;drain&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>())
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;end&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>));
</span></span></code></pre></div><p>Let&rsquo;s examine <code>RedisClient.#tick</code> method and related methods</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>(<span style="color:#a6e22e">force</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">writableNeedDrain</span> <span style="color:#f92672">||</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">force</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">isReady</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">cork</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">writableNeedDrain</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">args</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">getCommandToSend</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">args</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">writeCommand</span>(<span style="color:#a6e22e">args</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#a6e22e">getCommandToSend</span>()<span style="color:#f92672">:</span> <span style="color:#a6e22e">RedisCommandArguments</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">undefined</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toSend</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingToBeSent</span>.<span style="color:#a6e22e">shift</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">toSend</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">encoded</span>: <span style="color:#66d9ef">RedisCommandArguments</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">encoded</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">encodeCommand</span>(<span style="color:#a6e22e">toSend</span>.<span style="color:#a6e22e">args</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">toSend</span>.<span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingForReply</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">resolve</span>: <span style="color:#66d9ef">toSend.resolve</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reject</span>: <span style="color:#66d9ef">toSend.reject</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">channelsCounter</span>: <span style="color:#66d9ef">toSend.channelsCounter</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">returnBuffers</span>: <span style="color:#66d9ef">toSend.returnBuffers</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">chainInExecution</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">toSend</span>.<span style="color:#a6e22e">chainId</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">encoded</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#a6e22e">writeCommand</span>(<span style="color:#a6e22e">args</span>: <span style="color:#66d9ef">RedisCommandArguments</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ClientClosedError</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toWrite</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">args</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">writableNeedDrain</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">socket</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">toWrite</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><code>this.#socket.cork()</code> is a rabbit hole on it&rsquo;s own. This <a href="https://baus.net/on-tcp_cork/">blog post</a> explains it in a good detail.</p>
<p><code>RedisCommandQueue.getCommandToSend</code> method will pop the first command off the the queue and encode the command in RESP2 protocol.
<code>RedisCommandQueue.#waitingForReply</code> queue is enqueued with node containing <code>RedisCommandQueue.addCommand</code> return value promise&rsquo;s
<code>resolve</code> and <code>reject</code> so they can be called once a response is recieved.</p>
<p>The encoded command is written to the socket in <code>RedisSocket.writeCommand</code> with <code>this.#socket.write</code>.
<code>RedisSocket.#writableNeedDrain</code> tracks if the TCP socket&rsquo;s buffer is full and stops <code>RedisClient.#tick</code> from enqueueing more commands.</p>
<blockquote>
<p>Returns true if the entire data was flushed successfully to the kernel buffer. Returns false if all or part of the data was queued in user memory. &lsquo;drain&rsquo; will be emitted when the buffer is again free.</p>
</blockquote>
<p><a href="https://nodejs.org/api/net.html#socketwritedata-encoding-callback">socket.write documentation</a></p>
<p>Is this handling backpressure? Yep. It seems so. Read this great <a href="https://ey3ball.github.io/posts/2014/07/17/node-streams-back-pressure/">blog post</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;drain&#39;</span>, () <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">tick</span>())
</span></span></code></pre></div><p><code>RedisClient.#tick</code> will enqueue command until <code>RedisSocket.#writableNeedDrain</code> is true.
<code>RedisClient.#tick</code> will be called again when <code>RedisSocket</code> will emit <code>drain</code>.</p>
<h3 id="reading-a-response">Reading a response</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RedisSocket</span>(<span style="color:#a6e22e">socketInitiator</span>, <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">socket</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">onReplyChunk</span>(<span style="color:#a6e22e">chunk</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#a6e22e">onReplyChunk</span>(<span style="color:#a6e22e">chunk</span>: <span style="color:#66d9ef">Buffer</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">chunk</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><code>RedisSocket</code> will queue data coming from the TCP socket to <code>RedisCommandQueue.onReplyChunk</code> method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">decoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">RESP2Decoder</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">returnStringsAsBuffers</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">!!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingForReply</span>.<span style="color:#a6e22e">head</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">returnBuffers</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">pubSubState</span>.<span style="color:#a6e22e">isActive</span>;
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">onReply</span>: <span style="color:#66d9ef">reply</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">handlePubSubReply</span>(<span style="color:#a6e22e">reply</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingForReply</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Got an unexpected reply from Redis&#39;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">waitingForReply</span>.<span style="color:#a6e22e">shift</span>()<span style="color:#f92672">!</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">instanceof</span> <span style="color:#a6e22e">ErrorReply</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">reply</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">reply</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><p><code>RESP2Decoder</code> will decode the response and call <code>onReply</code>.
<code>RedisCommandQueue.#waitingForReply</code> will pop a node so that it can finally settle to the Promise that was created in <code>RedisCommandQueue.addCommand</code>.</p>
<p>What a journey! I feel great understanding how all this works.</p>
</div>


    </main>

    

    <script defer data-domain="blog.vramana.com" src="https://plausible.vramana.com/js/script.js"></script>
  </body>
</html>
